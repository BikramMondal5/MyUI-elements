<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bhumi - AI Assistant</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Add Markdown parser library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <style>
      /* CSS Styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
      }
      
      body {
        font-size: 16px;
        min-height: 100vh;
        overflow: hidden;
        background-color: #f5f5f5;
        position: relative;
      }
      
      /* Chat widget container - initially collapsed */
      .chat-widget-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
      }
      
      /* Chat toggle button */
      .chat-toggle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: #A855F7;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        z-index: 1002;
      }
      
      .chat-toggle:hover {
        transform: scale(1.05);
        background-color: #5718b3;
      }
      
      .chat-toggle i {
        color: white;
        font-size: 24px;
      }
      
      /* Chat container - full expanded chat */
      .container {
        width: 370px;
        height: 590px;
        background-color: #202020;
        color: #fff;
        box-sizing: border-box;
        overflow: hidden;
        position: relative;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        transform: scale(0);
        opacity: 0;
        transform-origin: bottom right;
        position: absolute;
        bottom: 75px;
        right: 0;
      }
      
      /* Active state for container */
      .container.active {
        transform: scale(1);
        opacity: 1;
      }
      
      header {
        background-color: #1b1b1d;
        color: #fff;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      
      .profile-badge {
        border: 1px solid #a855f7;
        border-radius: 25px;
        padding: 5px 15px;
        display: flex;
        color: #a855f7;
        align-items: center;
        font-weight: normal;
      }
      
      .close-button {
        color: #888;
        font-size: 1.2rem;
        cursor: pointer;
      }
      
      .main-container {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: calc(100% - 55px);
        position: relative;
        color: #fff;
      }
      
      .chat-container {
        position: absolute;
        bottom: 20px;
        left: 0;
        right: 0;
        padding: 10px 20px;
        display: flex;
        align-items: center;
        background-color: rgba(32, 32, 32, 0.9);
        backdrop-filter: blur(5px);
        box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
        z-index: 10;
      }
      
      .main-content {
        flex: 1;
        background: transparent;
        border-radius: 10px;
        overflow-y: auto;
        padding: 20px;
        padding-bottom: 100px; /* Extra padding at bottom */
        scrollbar-width: thin;
        scrollbar-color: #4b5563 #374151;
        height: calc(100% - 70px);
        color: #fff;
        display: flex;
        flex-direction: column;
      }
      
      /* Add pseudo-element for additional scrollable space */
      .main-content:after {
        content: "";
        display: block;
        height: 70px;
      }
      
      .chat-box {
        height: 50px;
        width: 100%;
        background-color: #333;
        border: 1px solid #444;
        border-radius: 25px;
        padding: 10px 50px 10px 20px;
        font-size: 1rem;
        color: #fff;
        outline: none;
        transition: border-color 0.2s ease;
        resize: none;
      }
      
      .chat-box:focus {
        border-color: #A855F7;
        box-shadow: 0 0 0 2px rgba(108, 49, 206, 0.1);
      }
      
      .chat-box::placeholder {
        color: #999;
      }
      
      .user-message {
        background: #6c31ce;
        color: white;
        padding: 10px 15px;
        border-radius: 10px;
        margin: 10px 0;
        align-self: flex-end;
        max-width: 70%;
        overflow-wrap: break-word;
      }
      
      .ai-message {
        background-color: #333;
        color: white;
        padding: 10px 15px;
        border-radius: 10px;
        margin: 10px 0;
        align-self: flex-start;
        max-width: 70%;
        overflow-wrap: break-word;
      }
      
      /* Markdown styling in AI messages */
      .ai-message code {
        background-color: #2d3748;
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
      }
      
      .ai-message pre {
        background-color: #2d3748;
        padding: 1em;
        border-radius: 5px;
        overflow-x: auto;
        margin: 0.5em 0;
      }
      
      .ai-message pre code {
        background-color: transparent;
        padding: 0;
        font-family: 'Courier New', monospace;
      }
      
      .ai-message h1, .ai-message h2, .ai-message h3, 
      .ai-message h4, .ai-message h5, .ai-message h6 {
        margin-top: 0.8em;
        margin-bottom: 0.5em;
        font-weight: 600;
      }
      
      .ai-message p {
        margin-bottom: 0.75em;
      }
      
      .ai-message p:last-child {
        margin-bottom: 0;
      }
      
      .ai-message ul, .ai-message ol {
        padding-left: 1.5em;
        margin-bottom: 0.75em;
      }
      
      .ai-message blockquote {
        border-left: 3px solid #6b7280;
        padding-left: 1em;
        margin-left: 0;
        margin-right: 0;
        font-style: italic;
        color: #d1d5db;
      }
      
      .loading-message {
        font-style: italic;
        color: #d1d5db;
        margin: 10px 0;
        align-self: flex-start;
      }
      
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .run-btn {
        position: absolute;
        right: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #A855F7;
        color: #fff;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .run-btn:hover {
        background-color: #9333EA;
        transform: scale(1.05);
      }
      
      .run-btn:active {
        transform: scale(0.95);
      }
      
      .run-btn i {
        font-size: 1.2rem;
      }
      
      /* Welcome message styling */
      .welcome-header {
        text-align: center;
        margin-bottom: 20px;
        color: #ff95c8;
      }
      
      .colored-text {
        color: #ff95c8;
      }
      
      .avatar-container {
        display: flex;
        justify-content: center;
        margin: 20px 0;
      }
      
      .avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background-color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      
      .avatar img {
        width: 90%;
        height: 90%;
      }
      
      .welcome-title {
        text-align: center;
        font-size: 1.5rem;
        font-weight: bold;
        margin: 10px 0 20px;
      }
      
      .suggestion-buttons {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 20px;
      }
      
      .suggestion-button {
        background-color: #333;
        border: 1px solid #444;
        border-radius: 25px;
        padding: 15px;
        color: white;
        cursor: pointer;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        transition: background-color 0.2s;
      }
      
      .suggestion-button:hover {
        background-color: #444;
      }
      
      .suggestion-icon {
        margin-right: 10px;
        color: #98fb98;
      }
      
      /* Scrollbar styling */
      .main-content::-webkit-scrollbar {
        width: 6px;
      }
      
      .main-content::-webkit-scrollbar-track {
        background: #333;
      }
      
      .main-content::-webkit-scrollbar-thumb {
        background: #555;
        border-radius: 3px;
      }
      
      /* Special styles for our welcome message */
      .greeting-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 20px;
      }
      
      @media (max-width: 480px) {
        .container {
          width: 100%;
          height: 100vh;
          border-radius: 0;
          position: fixed;
          bottom: 0;
          right: 0;
        }
        
        .chat-toggle {
          bottom: 20px;
          right: 20px;
        }
      }
      
      @media (prefers-reduced-motion: reduce) {
        .run-btn, .chat-toggle, .container {
          transition: none;
        }
      }
      
      /* Typing indicator */
      .typing-indicator {
        display: flex;
        align-items: center;
        padding: 10px 15px;
      }
      
      .typing-indicator span {
        height: 8px;
        width: 8px;
        background: #d1d5db;
        border-radius: 50%;
        display: block;
        margin-right: 3px;
        animation: typing 1s infinite ease-in-out;
      }
      
      .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
      }
      
      .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
      }
      
      @keyframes typing {
        0%, 100% {
          transform: translateY(0);
          opacity: 0.5;
        }
        50% {
          transform: translateY(-5px);
          opacity: 1;
        }
      }
      
      .disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      
      .ai-message a {
        color: #6c31ce;
        text-decoration: underline;
      }
      
      .emoji {
        font-size: 1.2em;
        margin-right: 5px;
      }
      
      .plant-emoji {
        font-size: 1.2em;
        margin-left: 5px;
      }
      
      /* Animation for toggle button */
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(108, 49, 206, 0.4);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(108, 49, 206, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(108, 49, 206, 0);
        }
      }
      
      .pulse {
        animation: pulse 2s infinite;
      }
      .colored-text{
        color: #A855F7;
      }
    </style>
  </head>
  <body>
    <div class="chat-widget-container">
      <!-- Chat toggle button -->
      <div class="chat-toggle pulse">
        <i class="fa-solid fa-comment"></i>
      </div>
      
      <!-- Chat container (initially hidden) -->
      <div class="container">
        <header>
          <div class="profile-badge">Bhumi</div>
          <div class="close-button">×</div>
        </header>
        <main class="main-container">
          <div id="main-content" class="main-content">
            <!-- Initial welcome content will be added by JavaScript -->
          </div>
          <div id="chat-container" class="chat-container">
            <input
              id="chat-box"
              type="text"
              class="chat-box"
              placeholder="Ask me anything..."
            />
            <button id="run-btn" class="run-btn disabled">
              <i class="fa-solid fa-paper-plane"></i>
            </button>
          </div>
        </main>
      </div>
    </div>

    <script type="module">
      import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

      document.addEventListener("DOMContentLoaded", () => {
        // DOM Elements
        const chatBox = document.getElementById("chat-box");
        const runBtn = document.getElementById("run-btn");
        const chatHistory = document.getElementById("main-content");
        const chatToggle = document.querySelector(".chat-toggle");
        const chatContainer = document.querySelector(".container");
        const closeButton = document.querySelector(".close-button");
        
        // Initialize the markdown parser
        const markedOptions = {
          gfm: true,
          breaks: true,
          sanitize: false,
          smartypants: true
        };
        
        // Initialize Google Generative AI
        const apiKey = "AIzaSyCAk4mkNVUtb3Fqi1SoU_a4y6r7_sWhxxs"; // Replace with your actual API key
        const genAI = new GoogleGenerativeAI(apiKey);
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
        
        // Toggle chat widget
        chatToggle.addEventListener("click", () => {
          chatContainer.classList.add("active");
          chatToggle.style.display = "none";
          // Focus the input after opening
          setTimeout(() => {
            chatBox.focus();
          }, 300);
        });
        
        // Close chat
        closeButton.addEventListener("click", () => {
          chatContainer.classList.remove("active");
          chatToggle.style.display = "flex";
        });
        
        // Add welcome screen content
        function addWelcomeScreen() {
          const welcomeHTML = `
            <div class="greeting-container">
              <h2 class="welcome-header">Let's build <span class="colored-text">together!</span></h2>
              
              <div class="avatar-container">
                <div class="avatar">
                  <img src="https://img.freepik.com/free-vector/graident-ai-robot-vectorart_78370-4114.jpg" alt="AI Assistant" />
                </div>
              </div>
              
              <h3 class="welcome-title">What can I help you with?</h3>
              
              <div class="suggestion-buttons">
                <div class="suggestion-button" id="suggestion-1">
                  <span class="suggestion-icon">🌾</span> How can I improve soil fertility for rice farming?
                </div>
                <div class="suggestion-button" id="suggestion-2">
                  <span class="suggestion-icon">🌱</span> How can I control pests in tomatoes?
                </div>
              </div>
            </div>
          `;
          
          chatHistory.innerHTML = welcomeHTML;
          
          // Add event listeners to suggestion buttons
          document.getElementById("suggestion-1").addEventListener("click", () => {
            chatBox.value = "How can I improve soil fertility for rice farming?";
            runBtn.classList.remove("disabled");
            processUserMessage();
          });
          
          document.getElementById("suggestion-2").addEventListener("click", () => {
            chatBox.value = "How can I control pests in tomatoes?";
            runBtn.classList.remove("disabled");
            processUserMessage();
          });
        }
        
        // Add welcome screen on load
        addWelcomeScreen();
        
        // Generate response from Gemini
        async function geminiResponse(userInput) {
          try {
            const result = await model.generateContent(userInput);
            const response = await result.response;
            return response.text();
          } catch (error) {
            console.error("Error generating content:", error);
            return "Sorry, I encountered an error processing your request. Please try again.";
          }
        }
        
        // Process markdown in AI responses
        function renderMarkdown(text) {
          try {
            // First convert URLs to actual links
            const linkedText = linkify(text);
            // Then render the markdown
            return marked.parse(linkedText, markedOptions);
          } catch (error) {
            console.error("Error rendering markdown:", error);
            return text;
          }
        }
        
        // Add messages to chat history
        function addMessageToHistory(message, isUser = false) {
          // Check if this is the first message - if so, clear the welcome screen
          if (document.querySelector(".greeting-container")) {
            chatHistory.innerHTML = "";
          }
          
          const messageDiv = document.createElement("div");
          messageDiv.className = isUser ? "user-message" : "ai-message";
          
          if (isUser) {
            // User messages don't need markdown rendering
            messageDiv.textContent = message;
          } else {
            // AI messages get markdown rendering
            messageDiv.innerHTML = renderMarkdown(message);
            
            // Make sure code blocks are properly styled
            const codeBlocks = messageDiv.querySelectorAll('pre code');
            if (codeBlocks.length > 0) {
              // Add syntax highlighting class if available
              codeBlocks.forEach(block => {
                block.classList.add('language-javascript');
              });
            }
          }
          
          // Add animation for better interaction
          messageDiv.style.animation = "fadeIn 0.3s ease-in-out";
          
          chatHistory.appendChild(messageDiv);
          scrollToBottom();
        }
        
        // Convert URLs in text to clickable links
        function linkify(text) {
          const urlRegex = /(https?:\/\/[^\s]+)/g;
          return text.replace(urlRegex, url => `<a href="${url}" target="_blank">${url}</a>`);
        }
        
        // Smooth scroll to bottom of chat
        function scrollToBottom() {
          chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        // Display typing indicator
        function showTypingIndicator() {
          const loadingDiv = document.createElement("div");
          loadingDiv.innerHTML = "<div class='typing-indicator'><span></span><span></span><span></span></div>";
          loadingDiv.className = "loading-message";
          loadingDiv.id = "typing-indicator";
          chatHistory.appendChild(loadingDiv);
          scrollToBottom();
          return loadingDiv;
        }
        
        // Process user message and get AI response
        async function processUserMessage() {
          const userMessage = chatBox.value.trim();
          if (userMessage === "") return;
          
          // Add user message to chat
          addMessageToHistory(userMessage, true);
          chatBox.value = "";
          
          // Update button state
          runBtn.classList.add("disabled");
          
          // Show typing indicator
          const loadingDiv = showTypingIndicator();
          
          // Create enhanced prompt with context
          const enhancedPrompt = `Your name is Bhumi, an agricultural AI assistant. You help farmers and gardeners with advice on growing plants, improving soil health, pest management, and sustainable farming practices. You should use appropriate emojis occasionally and keep your responses helpful and concise. You can use markdown formatting in your responses for better readability. Please respond to this query: ${userMessage}`;
          
          try {
            // Get AI response
            const response = await geminiResponse(enhancedPrompt);
            
            // Remove typing indicator and add response
            chatHistory.removeChild(loadingDiv);
            addMessageToHistory(response);
          } catch (error) {
            chatHistory.removeChild(loadingDiv);
            addMessageToHistory("Error: Unable to process the request. Please try again.");
          }
        }
        
        // Event Listeners
        runBtn.addEventListener("click", () => {
          if (!runBtn.classList.contains("disabled")) {
            processUserMessage();
          }
        });
        
        chatBox.addEventListener("keypress", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            if (!runBtn.classList.contains("disabled")) {
              processUserMessage();
            }
          }
        });
        
        // Update button state based on input
        chatBox.addEventListener("input", () => {
          if (chatBox.value.trim() === "") {
            runBtn.classList.add("disabled");
          } else {
            runBtn.classList.remove("disabled");
          }
        });
        
        // Add window resize handler to ensure proper scrolling
        window.addEventListener("resize", scrollToBottom);
        
        // Handle clicks outside the chat widget to close it
        document.addEventListener("click", (e) => {
          // Check if click is outside both the chat container and toggle button
          if (!chatContainer.contains(e.target) && 
              !chatToggle.contains(e.target) && 
              chatContainer.classList.contains("active")) {
            chatContainer.classList.remove("active");
            chatToggle.style.display = "flex";
          }
        });
      });
    </script>
  </body>
</html>
